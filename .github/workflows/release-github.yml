name: Create GitHub Release

on:
  workflow_run:
    workflows: ["Release crates.io", "Release PyPI", "Release npm"]
    types: [completed]
    branches: [main]

permissions:
  contents: write
  actions: read

jobs:
  create-release:
    name: Create Unified GitHub Release
    runs-on: ubuntu-latest
    # Only run when triggered by a tag push and all workflows succeeded
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      startsWith(github.event.workflow_run.head_branch, 'v')
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6

      - name: Get tag name
        id: tag
        run: |
          TAG="${{ github.event.workflow_run.head_branch }}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT

      - name: Check all release workflows completed
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.tag.outputs.tag }}"

          # Check status of all three release workflows for this tag
          CRATES_STATUS=$(gh run list --workflow="Release crates.io" --branch="$TAG" --json conclusion -q '.[0].conclusion' || echo "pending")
          PYPI_STATUS=$(gh run list --workflow="Release PyPI" --branch="$TAG" --json conclusion -q '.[0].conclusion' || echo "pending")
          NPM_STATUS=$(gh run list --workflow="Release npm" --branch="$TAG" --json conclusion -q '.[0].conclusion' || echo "pending")

          echo "crates.io: $CRATES_STATUS"
          echo "PyPI: $PYPI_STATUS"
          echo "npm: $NPM_STATUS"

          if [[ "$CRATES_STATUS" == "success" && "$PYPI_STATUS" == "success" && "$NPM_STATUS" == "success" ]]; then
            echo "all_success=true" >> $GITHUB_OUTPUT
          else
            echo "all_success=false" >> $GITHUB_OUTPUT
          fi

      - name: Download PyPI artifacts
        if: steps.check.outputs.all_success == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          mkdir -p artifacts/pypi

          # Get the run ID for PyPI workflow
          RUN_ID=$(gh run list --workflow="Release PyPI" --branch="$TAG" --json databaseId -q '.[0].databaseId')

          # Download all wheel artifacts
          gh run download "$RUN_ID" -D artifacts/pypi || true

      - name: Download npm artifacts
        if: steps.check.outputs.all_success == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          mkdir -p artifacts/npm

          # Get the run ID for npm workflow
          RUN_ID=$(gh run list --workflow="Release npm" --branch="$TAG" --json databaseId -q '.[0].databaseId')

          # Download all node artifacts
          gh run download "$RUN_ID" -D artifacts/npm || true

      - name: List artifacts
        if: steps.check.outputs.all_success == 'true'
        run: |
          echo "=== PyPI artifacts ==="
          find artifacts/pypi -type f -name "*.whl" -o -name "*.tar.gz" 2>/dev/null || echo "No PyPI artifacts"
          echo ""
          echo "=== npm artifacts ==="
          find artifacts/npm -type f -name "*.node" 2>/dev/null || echo "No npm artifacts"

      - name: Create GitHub Release
        if: steps.check.outputs.all_success == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.tag }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/**/*.whl
            artifacts/**/*.tar.gz
            artifacts/**/*.node
          body: |
            ## Installation

            **Rust (crates.io):**
            ```bash
            cargo add feedparser-rs
            ```

            **Python (PyPI):**
            ```bash
            pip install feedparser-rs
            ```

            **Node.js (npm):**
            ```bash
            npm install feedparser-rs
            ```

            ## Links

            - [crates.io](https://crates.io/crates/feedparser-rs)
            - [PyPI](https://pypi.org/project/feedparser-rs/)
            - [npm](https://www.npmjs.com/package/feedparser-rs)

            See [CHANGELOG.md](CHANGELOG.md) for details.
